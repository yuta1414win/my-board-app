# ログイン機能テストガイド

## 📋 テスト環境準備

### 1. 開発サーバーの起動

```bash
npm run dev
```

アプリケーションが http://localhost:3001 で起動します。

### 2. データベース接続確認

MongoDB が起動していることを確認してください。

### 3. 環境変数確認

`.env.local` に以下の設定があることを確認：

- `MONGODB_URI`
- `NEXTAUTH_SECRET`
- `NEXTAUTH_URL=http://localhost:3001`

## 🧪 テスト項目とチェックポイント

### テスト1: 正常なログインフロー

#### 手順:

1. ブラウザで http://localhost:3001 にアクセス
2. ヘッダーの「ログイン」ボタンをクリック
3. `/auth/login` ページが表示されることを確認
4. 有効なメールアドレスとパスワードを入力
5. 「ログイン」ボタンをクリック

#### ✅ チェックポイント:

- [ ] ログインページが正しく表示される
- [ ] フォームのバリデーションが動作する
- [ ] ログイン成功後、`/board` にリダイレクトされる
- [ ] ヘッダーにユーザー名/メールアドレスが表示される
- [ ] ログインボタンが消え、ユーザーアイコンが表示される

---

### テスト2: 間違ったパスワード

#### 手順:

1. `/auth/login` にアクセス
2. 正しいメールアドレスを入力
3. 間違ったパスワードを入力
4. 「ログイン」ボタンをクリック

#### ✅ チェックポイント:

- [ ] エラーメッセージ「メールアドレスまたはパスワードが正しくありません。」が表示される
- [ ] ページがリダイレクトされない
- [ ] フォームの入力内容が保持される（パスワード以外）
- [ ] 再度正しいパスワードで試行できる

---

### テスト3: 未認証メールアドレス

#### 手順:

1. メール認証が完了していないユーザーでログイン試行
2. メールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

#### ✅ チェックポイント:

- [ ] エラーメッセージ「メールアドレスが確認されていません。確認メールをご確認ください。」が表示される
- [ ] ログインが拒否される
- [ ] 確認メールの再送信リンクが表示される（実装済みの場合）

---

### テスト4: ログアウト処理

#### 手順:

1. ログイン済みの状態で開始
2. ヘッダーのユーザーアイコンをクリック
3. ドロップダウンメニューが表示されることを確認
4. 「ログアウト」をクリック

#### ✅ チェックポイント:

- [ ] ドロップダウンメニューが正しく表示される
- [ ] メニューにユーザーのメールアドレスが表示される
- [ ] ログアウト後、ホームページ（`/`）にリダイレクトされる
- [ ] ヘッダーが未ログイン状態の表示に戻る
- [ ] 保護されたページ（`/board`）にアクセスするとログインページにリダイレクトされる

---

### テスト5: セッション維持の確認

#### 手順:

1. ログイン済みの状態で開始
2. ブラウザをリロード（F5）
3. 別のページに移動（例：`/board`）
4. ブラウザを閉じて再度開く
5. アプリケーションに再アクセス

#### ✅ チェックポイント:

- [ ] リロード後もログイン状態が維持される
- [ ] ページ遷移してもログイン状態が維持される
- [ ] ブラウザを閉じて再度開いてもログイン状態が維持される（30日間）
- [ ] クッキーに `authjs.session-token` が設定されている

---

### テスト6: ヘッダー表示の切り替え

#### 手順:

1. 未ログイン状態でホームページにアクセス
2. 各ページでヘッダーを確認
3. ログインする
4. 再度各ページでヘッダーを確認

#### ✅ チェックポイント:

**未ログイン時:**

- [ ] 「ログイン」ボタンが表示される
- [ ] 「新規登録」ボタンが表示される
- [ ] ユーザーアイコンが表示されない

**ログイン時:**

- [ ] ユーザー名またはメールアドレスが表示される
- [ ] ユーザーアイコンが表示される
- [ ] ログイン/新規登録ボタンが表示されない
- [ ] ドロップダウンメニューが機能する

---

### テスト7: 保護されたページへのアクセス

#### 手順:

1. ログアウト状態で `/board` に直接アクセス
2. ログインページにリダイレクトされることを確認
3. ログインを完了
4. 自動的に `/board` にリダイレクトされることを確認

#### ✅ チェックポイント:

- [ ] 未ログイン時、保護されたページにアクセスできない
- [ ] ログインページにリダイレクトされる
- [ ] URLに `callbackUrl=/board` が含まれる
- [ ] ログイン後、元々アクセスしようとしたページに戻る

---

### テスト8: ソーシャルログイン（Google/GitHub）

#### 手順:

1. `/auth/login` にアクセス
2. 「Googleでログイン」または「GitHubでログイン」をクリック
3. 各プロバイダーの認証画面で承認
4. アプリケーションにリダイレクトされることを確認

#### ✅ チェックポイント:

- [ ] OAuth認証画面が正しく表示される
- [ ] 承認後、`/board` にリダイレクトされる
- [ ] ヘッダーにユーザー情報が表示される
- [ ] 通常のログインと同じようにセッションが維持される

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

1. **ログインできない**
   - MongoDBが起動しているか確認
   - `.env.local` の設定を確認
   - ユーザーのメール認証状態を確認

2. **セッションが維持されない**
   - `NEXTAUTH_SECRET` が設定されているか確認
   - ブラウザのクッキーが有効か確認
   - `NEXTAUTH_URL` が正しいか確認

3. **リダイレクトが機能しない**
   - `middleware.ts` が正しく設定されているか確認
   - `auth.config.ts` の設定を確認

4. **ヘッダーが表示されない**
   - `layout.tsx` に `<Header />` が含まれているか確認
   - `SessionProvider` でラップされているか確認

---

## 📊 テスト結果記録表

| テスト項目         | 結果 | 実行日時 | 備考 |
| ------------------ | ---- | -------- | ---- |
| 正常なログイン     | ⬜   | -        | -    |
| 間違ったパスワード | ⬜   | -        | -    |
| 未認証メール       | ⬜   | -        | -    |
| ログアウト処理     | ⬜   | -        | -    |
| セッション維持     | ⬜   | -        | -    |
| ヘッダー表示       | ⬜   | -        | -    |
| ページ保護         | ⬜   | -        | -    |
| ソーシャルログイン | ⬜   | -        | -    |

---

## 🚀 次のステップ

テストが完了したら：

1. すべてのチェックポイントが合格であることを確認
2. 問題があれば修正を実施
3. 本番環境へのデプロイ準備
