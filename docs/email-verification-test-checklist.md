# メール認証機能テストチェックリスト

## 🚀 実行前準備

### ✅ 環境設定確認
- [ ] `.env.local` ファイルが存在し、必要な環境変数が設定されている
  - [ ] `MONGODB_URI` - データベース接続文字列
  - [ ] `RESEND_API_KEY` - メール送信API（テストでは必須でない場合もある）
  - [ ] `NEXT_PUBLIC_BASE_URL` - アプリケーションのベースURL
  - [ ] `NEXTAUTH_URL` - NextAuth設定URL
  - [ ] `NEXTAUTH_SECRET` - セッション暗号化キー

### ✅ アプリケーション起動
- [ ] `npm install` で依存関係がインストール済み
- [ ] `npm run dev` でアプリケーションが起動中
- [ ] ブラウザで http://localhost:3001 にアクセス可能

### ✅ データベース接続
- [ ] MongoDBサーバーが稼働中
- [ ] データベース接続が正常
- [ ] `npm run test:mongodb` が成功（スクリプトがある場合）

---

## 🧪 自動テスト実行

### 1. 包括的テスト実行
```bash
bash scripts/run-all-email-tests.sh
```

**期待される結果**:
- [ ] 環境変数チェック: 成功 ✅
- [ ] 依存関係チェック: 成功 ✅
- [ ] アプリケーション接続: 成功 ✅
- [ ] データベース接続: 成功 ✅
- [ ] ユニットテスト: 合格 ✅
- [ ] API統合テスト: 合格 ✅
- [ ] E2Eテスト: 合格 ✅
- [ ] パフォーマンステスト: 完了 ✅

### 2. 個別テスト実行

#### APIテスト
```bash
node scripts/test-email-verification.js
```

**チェックポイント**:
- [ ] テスト1: 有効なトークン認証 - 成功
- [ ] テスト2: 無効なトークン処理 - 成功
- [ ] テスト3: トークンなし処理 - 成功
- [ ] テスト4: 期限切れトークン処理 - 成功
- [ ] テスト5: 再送信機能 - 成功
- [ ] テスト6: 認証済みユーザー処理 - 成功
- [ ] テスト7: データベース状態確認 - 成功
- [ ] 総合結果: 7/7 テスト合格 ✅

#### E2Eテスト
```bash
npx playwright test tests/e2e/email-verification.spec.ts
```

**チェックポイント**:
- [ ] 正常な認証フロー - デモページ
- [ ] 無効なトークンでの認証エラー
- [ ] トークンなしでのアクセス
- [ ] 再送信ダイアログの動作
- [ ] レスポンシブデザインの確認
- [ ] キーボードナビゲーション
- [ ] APIレスポンスの確認
- [ ] エラー状態でのナビゲーション

---

## 🌐 手動ブラウザテスト

### 1. デモページテスト
URL: http://localhost:3001/auth/verify/demo

**UI確認**:
- [ ] ページタイトル「メール認証機能デモ」が表示
- [ ] 3つのテストシナリオボタンが表示
- [ ] 各シナリオの説明が読みやすく表示
- [ ] 実装済み機能リストが表示

**機能テスト**:
- [ ] 成功パターンボタンクリック → 認証ページに遷移
- [ ] 無効なトークンボタンクリック → エラー画面表示
- [ ] 期限切れトークンボタンクリック → エラー画面表示

### 2. 正常な認証フロー
実際の有効なトークンでテスト（テストユーザー作成後）

**画面遷移**:
- [ ] 認証URL(`/auth/verify?token=VALID_TOKEN`)にアクセス
- [ ] ローディング画面表示「メールアドレスを確認しています...」
- [ ] 成功画面に遷移
- [ ] 緑色のチェックマークアイコン表示
- [ ] 「確認完了！」メッセージ表示
- [ ] 5秒カウントダウン開始
- [ ] 自動的にログインページにリダイレクト

**データベース状態確認**:
```javascript
// MongoDBで確認
db.users.findOne(
  { email: "test@example.com" },
  { emailVerified: 1, emailVerificationToken: 1, emailVerificationExpires: 1 }
)
```
- [ ] `emailVerified: true`
- [ ] `emailVerificationToken: null`
- [ ] `emailVerificationExpires: null`

### 3. エラーケーステスト

#### 無効なトークン
URL: http://localhost:3001/auth/verify?token=invalid_token

**期待される画面**:
- [ ] 赤色のエラーアイコン表示
- [ ] 「確認に失敗しました」ヘッダー
- [ ] 「無効または期限切れのトークンです」エラーメッセージ
- [ ] 「確認メールを再送信」ボタン表示
- [ ] ナビゲーションリンク（新規登録、ログイン、ホーム）表示

#### トークンなし
URL: http://localhost:3001/auth/verify

**期待される画面**:
- [ ] エラーアイコン表示
- [ ] 「確認トークンが見つかりません」エラーメッセージ

### 4. 再送信機能テスト

**ダイアログ操作**:
- [ ] 「確認メールを再送信」ボタンクリック
- [ ] ダイアログが開く
- [ ] メールアドレス入力フィールド表示
- [ ] 「再送信」「キャンセル」ボタン表示
- [ ] 有効なメールアドレス入力
- [ ] 「再送信」ボタンが有効化
- [ ] 再送信実行（成功/失敗メッセージ表示）
- [ ] 「キャンセル」でダイアログ閉じる

---

## 📱 レスポンシブ・アクセシビリティテスト

### レスポンシブデザイン
**各画面サイズで確認**:
- [ ] **モバイル** (375px): レイアウト適切、ボタンタップしやすい
- [ ] **タブレット** (768px): 適切な余白、読みやすい
- [ ] **デスクトップ** (1200px): 中央揃え、適切な最大幅

### キーボードナビゲーション
- [ ] `Tab`キーでフォーカス移動
- [ ] ボタン・リンクがフォーカス表示
- [ ] `Enter`キーで選択実行
- [ ] `Escape`キーでダイアログ閉じる

### アクセシビリティ
- [ ] 色のみに依存しない情報伝達
- [ ] 十分なコントラスト比
- [ ] 適切なARIA属性
- [ ] スクリーンリーダー対応

---

## ⚡ パフォーマンステスト

### レスポンス時間
```bash
curl -w "%{time_total}s\n" -s -o /dev/null "http://localhost:3001/api/auth/verify?token=test"
```
- [ ] APIレスポンス < 500ms
- [ ] ページ読み込み < 3秒
- [ ] UI操作の応答性良好

### 同時アクセステスト
```bash
ab -n 100 -c 10 "http://localhost:3001/auth/verify?token=test"
```
- [ ] 同時アクセス時の動作確認
- [ ] エラー率の確認

---

## 🐛 エラー処理テスト

### ネットワークエラー
- [ ] ネットワーク切断時のエラーハンドリング
- [ ] タイムアウト処理
- [ ] 適切なエラーメッセージ表示

### データベースエラー
- [ ] DB接続切断時の処理
- [ ] トランザクション失敗時の処理
- [ ] 適切なログ出力

### メール送信エラー
- [ ] 無効なAPI設定での処理
- [ ] レート制限時の処理
- [ ] 送信失敗時のユーザーフィードバック

---

## 📊 テスト結果記録

### テスト実行情報
- **実行日時**: _____________
- **実行者**: _____________
- **環境**: _____________
  - OS: _____________
  - ブラウザ: _____________
  - Node.js: _____________

### 結果サマリー
- **自動テスト**: ___/___合格
- **手動テスト**: ___/___合格
- **パフォーマンス**: 合格 / 不合格
- **アクセシビリティ**: 合格 / 不合格

### 発見された問題
1. _________________________________
2. _________________________________
3. _________________________________

### 改善点
1. _________________________________
2. _________________________________
3. _________________________________

---

## ✅ テスト完了基準

**すべてのテストが以下を満たすこと**:
- [ ] 全自動テスト合格（7/7 API + E2E）
- [ ] 手動テスト全項目チェック完了
- [ ] レスポンス時間基準達成（<500ms）
- [ ] レスポンシブデザイン動作確認
- [ ] アクセシビリティ基準達成
- [ ] エラーハンドリング適切
- [ ] データベース状態正常
- [ ] セキュリティ要件満足

**テスト完了サイン**: _______________ 日付: _______________

---

## 🚨 問題発生時の対処

### よくある問題と解決方法

1. **テスト失敗時**
   - ログを確認: `console.log`出力
   - データベース状態を直接確認
   - テストガイド参照: `docs/email-verification-test-guide.md`

2. **環境問題**
   - 環境変数再確認
   - アプリケーション再起動
   - データベース接続確認

3. **パフォーマンス問題**
   - ネットワーク状態確認
   - サーバー負荷確認
   - クエリ最適化検討

**サポート**: 技術仕様書とトラブルシューティングガイドを参照してください。